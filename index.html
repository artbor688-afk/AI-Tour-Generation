<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ Happy Tourist | AI Tour Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;900&display=swap');
        body { font-family: 'Montserrat', sans-serif; background: #0f172a; color: white; margin: 0; overflow-x: hidden; }
        .leaflet-control-attribution { display: none !important; }
        #map { height: 450px; width: 100%; border-radius: 24px; border: 4px solid #fff; z-index: 10; background: #1e293b; }
        .snow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .cat-btn { transition: 0.3s; opacity: 0.4; cursor: pointer; border: 2px solid transparent; }
        .cat-btn.active { opacity: 1; border-color: white; transform: scale(1.05); }
        .btn-main { background: linear-gradient(45deg, #ef4444, #b91c1c); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }
        .map-label { color: white; padding: 4px 8px; border-radius: 8px; font-weight: 900; font-size: 9px; border: 2px solid white; background: rgba(0,0,0,0.8); white-space: nowrap; text-transform: uppercase; }
        .user-dot { width: 18px; height: 18px; background: #3b82f6; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px #3b82f6; position: relative; }
        .user-dot::after { content: ''; position: absolute; width: 40px; height: 40px; background: rgba(59, 130, 246, 0.4); border-radius: 50%; top: -14px; left: -14px; animation: sonar 2s infinite; }
        @keyframes sonar { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        #res-list::-webkit-scrollbar { width: 4px; }
        #res-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-6">

    <canvas class="snow" id="snowCanvas"></canvas>

    <div class="max-w-7xl mx-auto relative z-10">
        <header class="text-center mb-4">
            <h1 class="text-4xl font-black italic uppercase tracking-tighter text-white">
                <span class="text-red-500">HAPPY</span> TOURIST üéÅ
            </h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div class="glass-card p-5 rounded-[2rem] shadow-2xl border-t-4 border-red-500">
                    <div class="space-y-3">
                        <div class="relative">
                            <label class="text-[9px] font-black uppercase text-gray-400 ml-1">–û—Ç–∫—É–¥–∞ (–ì–æ—Ä–æ–¥ –∏–ª–∏ GPS):</label>
                            <input id="startInput" type="text" class="w-full p-3 bg-black/40 border border-white/10 rounded-xl outline-none focus:border-blue-500 text-sm" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ üõ∞Ô∏è">
                            <button id="gpsBtn" onclick="toggleUltraGPS()" class="absolute right-2 top-7 bg-slate-700 p-2 rounded-lg hover:bg-blue-600 transition-all">üõ∞Ô∏è</button>
                        </div>
                        <div>
                            <label class="text-[9px] font-black uppercase text-gray-400 ml-1">–ö—É–¥–∞ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                            <input id="endInput" type="text" class="w-full p-3 bg-black/40 border border-white/10 rounded-xl outline-none focus:border-red-500 text-sm" placeholder="–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞">
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <button onclick="toggleCat('tourism', '–ì–ò–î', '#3b82f6', this)" class="cat-btn active p-2 rounded-lg text-[9px] font-black bg-blue-600 uppercase">üèõÔ∏è –ì–∏–¥</button>
                        <button onclick="toggleCat('museum', '–ú–£–ó–ï–ô', '#06b6d4', this)" class="cat-btn active p-2 rounded-lg text-[9px] font-black bg-cyan-600 uppercase">üé® –ú—É–∑–µ–π</button>
                        <button onclick="toggleCat('mall', '–®–û–ü', '#a855f7', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-purple-600 uppercase">üéÅ –®–æ–ø–∏–Ω–≥</button>
                        <button onclick="toggleCat('restaurant', '–ï–î–ê', '#ef4444', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-red-600 uppercase">üç± –ï–¥–∞</button>
                        <button onclick="toggleCat('hotel', '–û–¢–ï–õ–¨', '#f59e0b', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-orange-600 uppercase">üè® –û—Ç–µ–ª–∏</button>
                        <button onclick="toggleCat('park', '–ü–ê–†–ö', '#10b981', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-green-600 uppercase">üå≥ –ü–∞—Ä–∫–∏</button>
                    </div>

                    <button id="goBtn" onclick="buildRoute()" class="btn-main w-full mt-5 p-4 rounded-2xl font-black text-lg uppercase italic shadow-xl transition-all active:scale-95">
                        –ü–û–°–¢–†–û–ò–¢–¨ –¢–£–† üöÄ
                    </button>
                </div>

                <div id="list-card" class="glass-card p-5 rounded-[2rem] hidden overflow-hidden">
                    <h3 class="text-[10px] font-black uppercase text-red-500 mb-3 tracking-widest">–°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫:</h3>
                    <div id="res-list" class="max-h-[120px] overflow-y-auto space-y-2 text-[11px] font-bold"></div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div id="map"></div>
                
                <div id="info-panel" class="glass-card p-5 rounded-[2rem] hidden flex justify-between items-center px-8 border-b-4 border-blue-500">
                    <div><p class="text-[9px] font-black text-gray-400 uppercase">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</p><p id="res-dist" class="text-2xl font-black text-white italic">---</p></div>
                    <div class="h-10 w-px bg-white/10"></div>
                    <div><p class="text-[9px] font-black text-gray-400 uppercase">–í—Ä–µ–º—è</p><p id="res-time" class="text-2xl font-black text-green-400 italic">---</p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, routeLine, markers = [], userMarker, watchID = null;
        let selectedCats = [{type:'tourism', label:'–ì–ò–î', color:'#3b82f6'}, {type:'museum', label:'–ú–£–ó–ï–ô', color:'#06b6d4'}];

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            initSnow();
        }

        function toggleUltraGPS() {
            const btn = document.getElementById('gpsBtn');
            const input = document.getElementById('startInput');
            if (watchID) {
                navigator.geolocation.clearWatch(watchID); watchID = null;
                btn.classList.replace('bg-blue-600', 'bg-slate-700'); input.value = ""; input.readOnly = false;
                if(userMarker) map.removeLayer(userMarker); userMarker = null;
            } else {
                btn.classList.replace('bg-slate-700', 'bg-blue-600'); input.value = "–ü–æ–∏—Å–∫ —Å–ø—É—Ç–Ω–∏–∫–æ–≤..."; input.readOnly = true;
                watchID = navigator.geolocation.watchPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    if (!userMarker) {
                        userMarker = L.marker(latlng, { icon: L.divIcon({ className: 'user-dot' }) }).addTo(map);
                        map.setView(latlng, 15);
                    } else { userMarker.setLatLng(latlng); }
                    input.value = "GPS: –ê–∫—Ç–∏–≤–µ–Ω üõ∞Ô∏è";
                }, err => { alert("–û—à–∏–±–∫–∞ GPS: " + err.message); toggleUltraGPS(); }, { enableHighAccuracy: true });
            }
        }

        function toggleCat(type, label, color, btn) {
            const index = selectedCats.findIndex(c => c.type === type);
            if (index > -1) { selectedCats.splice(index, 1); btn.classList.remove('active'); }
            else { selectedCats.push({ type, label, color }); btn.classList.add('active'); }
        }

        async function buildRoute() {
            const startInput = document.getElementById('startInput').value;
            let startPos;
            const btn = document.getElementById('goBtn');
            btn.innerText = "–ü–û–ò–°–ö –ö–û–û–†–î–ò–ù–ê–¢...";

            if (userMarker) {
                startPos = { lat: userMarker.getLatLng().lat, lon: userMarker.getLatLng().lng };
            } else {
                if (!startInput) return alert("–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥!");
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(startInput)}`);
                const data = await res.json();
                if (data.length) startPos = { lat: data[0].lat, lon: data[0].lon };
            }

            if (!startPos) { btn.innerText = "–û–®–ò–ë–ö–ê –ê–î–†–ï–°–ê"; return; }

            markers.forEach(m => map.removeLayer(m)); markers = [];
            if (routeLine) map.removeLayer(routeLine);
            document.getElementById('res-list').innerHTML = "";

            let coords = [`${startPos.lon},${startPos.lat}`];

            for (let cat of selectedCats) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${cat.type}&viewbox=${+startPos.lon-0.08},${+startPos.lat+0.08},${+startPos.lon+0.08},${+startPos.lat-0.08}&bounded=1&limit=3`;
                const poiData = await (await fetch(url)).json();
                poiData.forEach(p => {
                    coords.push(`${p.lon},${p.lat}`);
                    const icon = L.divIcon({ className: 'label', html: `<div class="map-label" style="border-color:${cat.color}">${cat.label}</div>` });
                    markers.push(L.marker([p.lat, p.lon], {icon}).addTo(map));
                    document.getElementById('res-list').innerHTML += `<div><span style="color:${cat.color}">‚óè</span> ${p.display_name.split(',')[0]}</div>`;
                });
            }

            const endVal = document.getElementById('endInput').value;
            if (endVal) {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endVal)}`);
                const data = await res.json();
                if (data.length) coords.push(`${data[0].lon},${data[0].lat}`);
            }

            btn.innerText = "–†–ò–°–£–ï–ú –ü–£–¢–¨...";
            try {
                const rRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords.join(';')}?overview=full&geometries=geojson`);
                const rData = await rRes.json();
                if (rData.code === 'Ok') {
                    const latLngs = rData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    routeLine = L.polyline(latLngs, {color:'#ef4444', weight:6, opacity:0.9}).addTo(map);
                    map.fitBounds(routeLine.getBounds(), {padding: [30, 30]});
                    document.getElementById('info-panel').classList.remove('hidden');
                    document.getElementById('list-card').classList.remove('hidden');
                    document.getElementById('res-dist').innerText = (rData.routes[0].distance/1000).toFixed(1) + " –∫–º";
                    document.getElementById('res-time').innerText = Math.round(rData.routes[0].duration/60) + " –º–∏–Ω";
                    btn.innerText = "–ì–û–¢–û–í–û! üöÄ";
                } else { btn.innerText = "–ú–ê–†–®–†–£–¢ –ù–ï –ù–ê–ô–î–ï–ù"; }
            } catch (e) { btn.innerText = "–û–®–ò–ë–ö–ê –°–ï–¢–ò"; }
        }

        function initSnow() {
            const canvas = document.getElementById('snowCanvas'); const ctx = canvas.getContext('2d');
            let w = canvas.width = window.innerWidth, h = canvas.height = window.innerHeight;
            const flakes = Array.from({length: 40}, () => ({x: Math.random()*w, y: Math.random()*h, r: Math.random()*3+1, d: Math.random()*0.5+0.2}));
            function draw() {
                ctx.clearRect(0,0,w,h); ctx.fillStyle = "white"; ctx.beginPath();
                flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); }); ctx.fill();
                flakes.forEach(f => { f.y += f.d; if(f.y > h) f.y = -10; });
                requestAnimationFrame(draw);
            }
            draw();
        }
        window.onload = initMap;
    </script>
</body>
</html>